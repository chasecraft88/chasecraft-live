<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameVibeHub - Epic Gaming Community</title>
    <meta name="description" content="Join GameVibeHub for Hearthstone streams, AI memes, polls, and global gaming vibes! Watch live on TikTok @whispers_from_within. #GameVibeHub">
    <meta name="keywords" content="Hearthstone, Fortnite, Minecraft, TikTok, gaming, AI memes, Discord, GameVibeHub">
    <meta name="author" content="ChaseCraft88">
    <meta property="og:title" content="GameVibeHub - Epic Gaming Community">
    <meta property="og:description" content="Join the ultimate gaming hub for streams, memes, and community fun!">
    <meta property="og:image" content="https://chasecraft88.github.io/chasecraft-live/og-image.jpg">
    <meta property="og:url" content="https://chasecraft88.github.io/chasecraft-live/">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        body {
            font-family: 'Orbitron', sans-serif;
            background: #1a202c;
            color: #e2e8f0;
            scroll-behavior: smooth;
            overflow-x: hidden;
            position: relative;
        }
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #1a202c, #2d3748);
        }
        #custom-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            transition: transform 0.1s ease;
        }
        #custom-cursor svg {
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.8));
        }
        .cursor-trail {
            position: fixed;
            width: 8px;
            height: 8px;
            background: rgba(255, 215, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 999;
            animation: fadeTrail 0.5s ease-out forwards;
        }
        @keyframes fadeTrail {
            to { opacity: 0; transform: scale(0); }
        }
        #sprite {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            animation: floatDown 15s linear infinite, bob 2s ease-in-out infinite, sway 4s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes floatDown {
            0% { top: -100px; }
            100% { top: 100%; }
        }
        @keyframes bob {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -10px); }
        }
        @keyframes sway {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-60%, 0); }
        }
        #sprite svg {
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .mana-explosion {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.8), transparent);
            border-radius: 50%;
            animation: explode 0.5s ease-out forwards;
            pointer-events: none;
        }
        @keyframes explode {
            to { transform: scale(2); opacity: 0; }
        }
        section {
            opacity: 0;
            transition: opacity 0.8s ease-out, box-shadow 0.8s ease-out;
            position: relative;
        }
        section.visible {
            opacity: 1;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .btn {
            transition: transform 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .btn:hover {
            transform: scale(1.05);
            background-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }
        .hero-bg {
            background: linear-gradient(180deg, #4b0082, #1a202c);
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        .typed-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            color: #ffffff;
            min-height: 2.5rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        #grok-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: #1a202c;
            border-left: 4px solid #ffd700;
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        #grok-panel.open {
            right: 0;
        }
        #grok-panel .chat-area {
            padding: 20px;
            color: #e2e8f0;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9rem;
        }
        #grok-panel .chat-message {
            background: #2d3748;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0;
            animation: fadeInChat 0.5s ease forwards;
        }
        @keyframes fadeInChat {
            to { opacity: 1; }
        }
        #grok-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        #book-banner {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #ffd700;
            color: #1a202c;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        #book-banner a {
            color: #4b0082;
            font-weight: bold;
            text-decoration: underline;
        }
        #meme-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        #meme-previews img {
            max-width: 150px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        #meme-previews img:hover {
            border: 2px solid #ffd700;
        }
        .error-message {
            color: #ff4444;
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div id="custom-cursor">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <rect x="4" y="4" width="12" height="12" fill="#ffd700" />
            <rect x="6" y="6" width="8" height="8" fill="#ffffff" />
            <rect x="8" y="8" width="2" height="2" fill="#ffd700" />
        </svg>
    </div>
    <div id="sprite">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
            <rect x="8" y="8" width="24" height="24" fill="#ffd700" />
            <rect x="12" y="12" width="16" height="16" fill="#ffffff" />
            <rect x="16" y="16" width="4" height="4" fill="#ffd700" />
            <rect x="24" y="16" width="4" height="4" fill="#ffd700" />
        </svg>
    </div>
    <div id="book-banner" class="fade-in" role="banner">
        <p>Discover <strong>Echo of Silence: Whispers of the Unseen</strong>! 
        <a href="https://www.amazon.com/Echo-Silence-Whispers-Unseen-ebook/dp/B0DDJVPYRB?ref_=ast_author_dp" target="_blank">Get it now on Amazon!</a></p>
    </div>
    <button id="grok-toggle" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg" aria-label="Toggle AI Chat">Chat with AI</button>
    <div id="grok-panel" role="complementary">
        <div class="chat-area">
            <h3 class="text-xl font-bold mb-4 text-yellow-500">AI GameVibe Banter</h3>
            <div id="grok-chat"></div>
            <input id="chat-input" type="text" placeholder="Talk smack or vibe..." class="bg-gray-800 text-white p-2 rounded w-full mb-2" aria-label="Chat input">
            <button id="chat-submit" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg w-full mb-2" aria-label="Send chat">Send</button>
            <button id="roast-me" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg w-full" aria-label="Get roasted">Roast Me!</button>
            <p id="chat-error" class="error-message hidden"></p>
        </div>
    </div>
    <section id="hero" class="hero-bg flex items-center justify-center text-center">
        <div class="container mx-auto px-4">
            <h1 class="text-5xl md:text-7xl font-bold text-yellow-500 mb-6 fade-in">GameVibeHub</h1>
            <p id="typed-text" class="typed-text mx-auto"></p>
            <div class="mt-8 space-x-4 fade-in">
                <a href="#tiktok-stream" class="btn inline-block bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg">Watch Live Stream</a>
                <a href="#meme" class="btn inline-block bg-yellow-500 text-gray-900 font-semibold py-3 px-6 rounded-lg">Create AI Memes</a>
            </div>
        </div>
    </section>
    <section id="tiktok-stream" class="py-20 bg-gray-900">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-12 fade-in">Live TikTok Stream</h2>
            <p class="text-xl text-gray-300 mb-6 fade-in">Catch <strong>@whispers_from_within</strong> streaming Hearthstone every evening at 8 PM EST! Next stream in: <span id="stream-countdown">Calculating...</span></p>
            <div class="max-w-2xl mx-auto fade-in">
                <lottie-player src="https://assets.lottiefiles.com/packages/lf20_kkflmtur.json" background="transparent" speed="1" style="width: 100%; height: 400px;" loop autoplay></lottie-player>
            </div>
            <a href="https://www.tiktok.com/@whispers_from_within" target="_blank" class="btn inline-block bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg mt-4 fade-in">Join on TikTok</a>
        </div>
    </section>
    <section id="poll" class="py-20 bg-gray-800">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-12 fade-in">Daily Gaming Poll</h2>
            <p class="text-xl text-gray-300 mb-6 fade-in">Vote for your favorite game and see what the community loves! #GameVibeHub</p>
            <div class="bg-gray-900 p-6 rounded-lg max-w-md mx-auto fade-in">
                <div class="mb-4">
                    <button class="poll-btn btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg mr-2" data-game="hearthstone">Hearthstone</button>
                    <button class="poll-btn btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg mr-2" data-game="fortnite">Fortnite</button>
                    <button class="poll-btn btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg" data-game="minecraft">Minecraft</button>
                </div>
                <div id="poll-results" class="text-gray-300"></div>
            </div>
        </div>
    </section>
    <section id="meme" class="py-20 bg-gray-900">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-12 fade-in">AI-Powered Meme Generator</h2>
            <p class="text-xl text-gray-300 mb-6 fade-in">Create epic gaming memes with AI and go viral with #GameVibeHub!</p>
            <div class="bg-gray-900 p-6 rounded-lg max-w-md mx-auto fade-in">
                <input id="meme-input" type="text" placeholder="Enter your meme text (e.g., Hearthstone fail)" class="bg-gray-800 text-white p-2 rounded mb-4 w-full" aria-label="Enter meme text">
                <select id="meme-template" class="bg-gray-800 text-white p-2 rounded mb-4 w-full" aria-label="Select meme template">
                    <option value="drake">Drake Hotline Bling</option>
                    <option value="distracted_bf">Distracted Boyfriend</option>
                    <option value="grumpy_cat">Grumpy Cat</option>
                    <option value="spongebob">Spongebob Mocking</option>
                </select>
                <button id="generate-meme" class="btn inline-block bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg mb-4" aria-label="Generate Meme">Generate AI Meme</button>
                <div id="meme-previews"></div>
                <p id="meme-error" class="error-message hidden"></p>
                <canvas id="meme-image" width="300" height="200" class="hidden"></canvas>
                <button id="download-meme" class="btn inline-block bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg mt-4 hidden" aria-label="Download Meme">Download Meme</button>
            </div>
        </div>
    </section>
    <section id="leaderboard" class="py-20 bg-gray-800">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-12 fade-in">Global Leaderboard</h2>
            <p class="text-xl text-gray-300 mb-6 fade-in">Submit your gaming score and climb the ranks! #GameVibeHub</p>
            <div class="bg-gray-900 p-6 rounded-lg max-w-md mx-auto fade-in">
                <input id="username" type="text" placeholder="Enter your username" class="bg-gray-800 text-white p-2 rounded mb-4 w-full" aria-label="Enter username">
                <input id="score" type="number" placeholder="Enter your score" class="bg-gray-800 text-white p-2 rounded mb-4 w-full" aria-label="Enter score">
                <button id="submit-score" class="btn inline-block bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg" aria-label="Submit score">Submit Score</button>
                <div id="leaderboard-list" class="mt-6 text-gray-300"></div>
            </div>
        </div>
    </section>
    <section id="gallery" class="py-20 bg-gray-900">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-12 fade-in">Community Gallery</h2>
            <p class="text-xl text-gray-300 mb-6 fade-in">Share your gaming moments and inspire the community! #GameVibeHub</p>
            <div class="bg-gray-900 p-6 rounded-lg max-w-md mx-auto fade-in">
                <input id="image-url" type="text" placeholder="Enter image URL" class="bg-gray-800 text-white p-2 rounded mb-4 w-full" aria-label="Enter image URL">
                <input id="caption" type="text" placeholder="Enter caption" class="bg-gray-800 text-white p-2 rounded mb-4 w-full" aria-label="Enter caption">
                <button id="submit-image" class="btn inline-block bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg" aria-label="Submit image">Submit Image</button>
                <div id="gallery-images" class="mt-6 flex flex-wrap gap-4 justify-center"></div>
            </div>
        </div>
    </section>
    <section id="quote" class="py-20 bg-gray-800">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-12 fade-in">Daily Gaming Quote</h2>
            <p id="daily-quote" class="text-xl text-gray-300 mb-6 fade-in italic">"Loading epic quote..."</p>
            <button id="new-quote" class="btn inline-block bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg fade-in">Get New Quote</button>
        </div>
    </section>
    <footer class="bg-gray-900 py-12 text-center">
        <div class="container mx-auto px-4">
            <p class="text-gray-300 mb-4 fade-in">© 2025 GameVibeHub. All rights reserved.</p>
            <div class="flex justify-center space-x-6 fade-in">
                <a href="https://www.tiktok.com/@whispers_from_within" target="_blank" class="text-yellow-500 hover:text-yellow-400" aria-label="TikTok"><i class="fab fa-tiktok fa-2x"></i></a>
                <a href="https://discord.gg/your-discord" target="_blank" class="text-yellow-500 hover:text-yellow-400" aria-label="Discord"><i class="fab fa-discord fa-2x"></i></a>
                <a href="https://twitter.com/ChaseCraft88" target="_blank" class="text-yellow-500 hover:text-yellow-400" aria-label="Twitter"><i class="fab fa-twitter fa-2x"></i></a>
            </div>
        </div>
    </footer>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, push, set, onValue } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB0QZQgiVJMmu0Dx91q5uYPsEEpWSDytoA",
            authDomain: "gamevibehub-ba607.firebaseapp.com",
            databaseURL: "https://gamevibehub-ba607-default-rtdb.firebaseio.com",
            projectId: "gamevibehub-ba607",
            storageBucket: "gamevibehub-ba607.firebasestorage.app",
            messagingSenderId: "743860292247",
            appId: "1:743860292247:web:63ca1a68cc6b480354b7d2"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Fetch OpenAI API key
        let OPENAI_API_KEY = '';
        async function loadApiKey() {
            const chatError = document.getElementById('chat-error');
            const memeError = document.getElementById('meme-error');
            try {
                const snapshot = await get(ref(database, 'secrets/openai_api_key'));
                if (snapshot.exists()) {
                    OPENAI_API_KEY = snapshot.val();
                    console.log('OpenAI API key loaded successfully');
                } else {
                    const errorMsg = 'OpenAI API key not found in Firebase. Please check /secrets/openai_api_key.';
                    console.error(errorMsg);
                    chatError.textContent = errorMsg;
                    memeError.textContent = errorMsg;
                    chatError.classList.remove('hidden');
                    memeError.classList.remove('hidden');
                }
            } catch (error) {
                const errorMsg = `Error fetching API key: ${error.message}`;
                console.error(errorMsg);
                chatError.textContent = errorMsg;
                memeError.textContent = errorMsg;
                chatError.classList.remove('hidden');
                memeError.classList.remove('hidden');
            }
        }
        await loadApiKey();

        // Particle.js
        particlesJS('particles-js', {
            particles: {
                number: { value: 80, density: { enable: true, value_area: 800 } },
                color: { value: '#ffd700' },
                shape: { type: 'circle' },
                opacity: { value: 0.5, random: false },
                size: { value: 3, random: true },
                line_linked: { enable: true, distance: 150, color: '#ffd700', opacity: 0.4, width: 1 },
                move: { enable: true, speed: 6, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
            },
            interactivity: {
                detect_on: 'canvas',
                events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
                modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
            },
            retina_detect: true
        });

        // Animation and Cursor
        document.addEventListener('DOMContentLoaded', () => {
            const cursor = document.getElementById('custom-cursor');
            const sprite = document.getElementById('sprite');
            document.addEventListener('mousemove', (e) => {
                cursor.style.left = `${e.clientX}px`;
                cursor.style.top = `${e.clientY}px`;
                const trail = document.createElement('div');
                trail.className = 'cursor-trail';
                trail.style.left = `${e.clientX - 4}px`;
                trail.style.top = `${e.clientY - 4}px`;
                document.body.appendChild(trail);
                setTimeout(() => trail.remove(), 500);
            });

            let typed;
            function startTyping() {
                typed = new Typed('#typed-text', {
                    strings: [
                        'Welcome to GameVibeHub!',
                        'Slam *Hearthstone* cards live on TikTok!',
                        'Build epic *Minecraft* creations!',
                        'Drop *Fortnite* dubs with us!',
                        'Create AI memes and go viral!',
                        'Chat with AI for epic vibes!',
                        'Join daily global challenges!'
                    ],
                    typeSpeed: 50,
                    backSpeed: 30,
                    backDelay: 1000,
                    loop: true,
                    showCursor: true,
                    cursorChar: '█'
                });
            }

            let hasTriggeredTyping = false;
            function checkSpritePosition() {
                if (!sprite) {
                    console.warn('Sprite element not found. Skipping position check.');
                    return;
                }
                const spriteRect = sprite.getBoundingClientRect();
                const spriteY = spriteRect.top + window.scrollY;
                const heroElement = document.getElementById('hero');
                if (!hasTriggeredTyping && heroElement && spriteY > heroElement.getBoundingClientRect().top + window.scrollY) {
                    startTyping();
                    hasTriggeredTyping = true;
                }
                document.querySelectorAll('section').forEach(section => {
                    const rect = section.getBoundingClientRect();
                    if (spriteY > rect.top + window.scrollY) {
                        section.classList.add('visible');
                    }
                });
                if (spriteY > document.body.scrollHeight) {
                    sprite.style.top = '-100px';
                }
                const cursorRect = cursor.getBoundingClientRect();
                const dx = spriteRect.left - cursorRect.left;
                const dy = spriteRect.top - cursorRect.top;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 100) {
                    sprite.style.animation = 'floatDown 15s linear infinite, bob 1s ease-in-out infinite, sway 4s ease-in-out infinite';
                } else {
                    sprite.style.animation = 'floatDown 15s linear infinite, bob 2s ease-in-out infinite, sway 4s ease-in-out infinite';
                }
            }
            function animate() {
                checkSpritePosition();
                requestAnimationFrame(animate);
            }
            animate();
        });

        // AI Chat Logic
        const grokToggle = document.getElementById('grok-toggle');
        const grokPanel = document.getElementById('grok-panel');
        const grokChat = document.getElementById('grok-chat');
        const chatInput = document.getElementById('chat-input');
        const chatSubmit = document.getElementById('chat-submit');
        const roastMe = document.getElementById('roast-me');
        const chatError = document.getElementById('chat-error');

        function addChatMessage(message, isUser = false) {
            const div = document.createElement('div');
            div.className = `chat-message ${isUser ? 'text-right bg-indigo-600' : 'bg-gray-800'}`;
            div.textContent = message;
            grokChat.appendChild(div);
            grokChat.scrollTop = grokChat.scrollHeight;
        }

        async function sendChatMessage(message, type = 'chat', retryCount = 0) {
            if (!OPENAI_API_KEY) {
                const errorMsg = 'Cannot connect to AI: API key not loaded.';
                addChatMessage(errorMsg);
                chatError.textContent = errorMsg;
                chatError.classList.remove('hidden');
                return;
            }

            let prompt;
            const timestamp = Date.now();
            switch (type) {
                case 'welcome':
                    prompt = `You're a witty AI on GameVibeHub, a gaming community for Hearthstone, Fortnite, and Minecraft. Generate a unique, funny welcome message for a new user. Include a gaming reference (e.g., Hearthstone mana, Fortnite dubs) and keep it under 50 words. Avoid repeating previous messages. Timestamp: ${timestamp}`;
                    break;
                case 'roast':
                    prompt = `You're a witty AI on GameVibeHub. Roast the user in a funny, gaming-themed way (e.g., Hearthstone, Fortnite, Minecraft). Keep it light, playful, and under 50 words. Make it unique and avoid repeating previous roasts. Timestamp: ${timestamp}`;
                    break;
                case 'chat':
                default:
                    prompt = `You're a witty AI on GameVibeHub, a gaming community. Respond to this user message: "${message}" with a funny, gaming-themed reply (e.g., Hearthstone, Fortnite, Minecraft). Keep it light, under 50 words, and include a gaming reference. Timestamp: ${timestamp}`;
                    break;
            }

            try {
                addChatMessage('Thinking...', false);
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 50,
                        temperature: 1.0,
                        top_p: 0.95
                    })
                });

                if (!response.ok) {
                    if (response.status === 429 && retryCount < 3) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        console.warn(`Rate limit hit. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return sendChatMessage(message, type, retryCount + 1);
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                if (data.choices && data.choices[0].message.content) {
                    const reply = data.choices[0].message.content.trim();
                    grokChat.lastChild.remove();
                    addChatMessage(reply);
                    if (type !== 'welcome') {
                        push(ref(database, 'chat'), { message: reply, timestamp: Date.now() });
                    }
                    chatError.classList.add('hidden');
                } else {
                    throw new Error('No response from OpenAI');
                }
            } catch (error) {
                grokChat.lastChild.remove();
                const errorMsg = `AI error: ${error.message}. Check console.`;
                addChatMessage(errorMsg);
                chatError.textContent = errorMsg;
                chatError.classList.remove('hidden');
                console.error('Chat error:', error);
            }
        }

        grokToggle.addEventListener('click', async () => {
            grokPanel.classList.toggle('open');
            if (grokPanel.classList.contains('open')) {
                grokChat.innerHTML = '';
                addChatMessage('Connecting to GameVibeHub AI...');
                await sendChatMessage('', 'welcome');
            }
        });

        chatSubmit.addEventListener('click', async () => {
            console.log('Chat submit clicked');
            const message = chatInput.value.trim();
            if (message) {
                addChatMessage(message, true);
                chatInput.value = '';
                await sendChatMessage(message, 'chat');
            }
        });

        roastMe.addEventListener('click', async () => {
            console.log('Roast Me clicked');
            addChatMessage('Brace yourself for an epic roast!');
            await sendChatMessage('', 'roast');
        });

        // Meme Generator Logic
        const memeInput = document.getElementById('meme-input');
        const memeTemplate = document.getElementById('meme-template');
        const generateMeme = document.getElementById('generate-meme');
        const memePreviews = document.getElementById('meme-previews');
        const memeCanvas = document.getElementById('meme-image');
        const downloadMeme = document.getElementById('download-meme');
        const memeError = document.getElementById('meme-error');
        const ctx = memeCanvas.getContext('2d');

        function drawFallbackMeme(text) {
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(0, 0, 300, 200);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(10, 10, 280, 180);
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(120, 80, 60, 40);
            ctx.fillStyle = '#ffffff';
            ctx.font = '16px Press Start 2P';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = '#000000';
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            const lines = text.match(/.{1,20}(\s|$)/g) || [text];
            lines.forEach((line, i) => {
                ctx.fillText(line.trim(), 150, 100 + i * 20);
            });
        }

        async function generateMemeCaption(text, retryCount = 0) {
            if (!OPENAI_API_KEY) {
                memeError.textContent = 'Cannot generate caption: API key not loaded.';
                memeError.classList.remove('hidden');
                return text;
            }
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: `Create a funny, gaming-themed meme caption for: "${text}". Keep it short (under 20 words), suitable for Hearthstone, Fortnite, or Minecraft. Timestamp: ${Date.now()}` }],
                        max_tokens: 30,
                        temperature: 1.0
                    })
                });

                if (!response.ok) {
                    if (response.status === 429 && retryCount < 3) {
                        const delay = Math.pow(2, retryCount) * 1000;
                        console.warn(`Rate limit hit for caption. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return generateMemeCaption(text, retryCount + 1);
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                return data.choices && data.choices[0].message.content ? data.choices[0].message.content.trim() : text;
            } catch (error) {
                console.error('Meme caption error:', error);
                memeError.textContent = `Caption error: ${error.message}`;
                memeError.classList.remove('hidden');
                return text;
            }
        }

        async function generateMemes(text, template, retryCount = 0) {
            memePreviews.innerHTML = '<p>Generating meme...</p>';
            memeError.classList.add('hidden');
            const caption = await generateMemeCaption(text || 'Your Meme Here');
            const words = caption.split(' ');
            const half = Math.ceil(words.length / 2);
            const topText = words.slice(0, half).join(' ').toUpperCase();
            const bottomText = words.slice(half).join(' ').toUpperCase();

            try {
                const response = await fetch('https://api.imgflip.com/caption_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        template_id: {
                            drake: '181913649',
                            distracted_bf: '112126428',
                            grumpy_cat: '405658',
                            spongebob: '102156234'
                        }[template],
                        username: 'YOUR_IMGFLIP_USERNAME', // Replace with your Imgflip username
                        password: 'YOUR_IMGFLIP_PASSWORD', // Replace with your Imgflip password
                        text0: topText,
                        text1: bottomText
                    })
                });

                const data = await response.json();
                if (data.success) {
                    memePreviews.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = data.data.url;
                    img.alt = 'Generated meme';
                    img.style.maxWidth = '150px';
                    img.onclick = () => {
                        const fullImg = new Image();
                        fullImg.crossOrigin = 'Anonymous';
                        fullImg.onload = () => {
                            ctx.drawImage(fullImg, 0, 0, 300, 200);
                            downloadMeme.classList.remove('hidden');
                        };
                        fullImg.src = data.data.url;
                    };
                    memePreviews.appendChild(img);
                    push(ref(database, 'memes'), { text: caption, url: data.data.url, timestamp: Date.now() });
                } else {
                    throw new Error(data.error_message || 'Imgflip API failed');
                }
            } catch (error) {
                if (error.message.includes('429') && retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    console.warn(`Rate limit hit for Imgflip. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateMemes(text, template, retryCount + 1);
                }
                drawFallbackMeme(caption);
                memePreviews.innerHTML = '<p>Failed to generate meme. Using fallback.</p>';
                memeError.textContent = `Meme error: ${error.message}`;
                memeError.classList.remove('hidden');
                console.error('Meme error:', error);
            }
        }

        generateMeme.addEventListener('click', () => {
            console.log('Generate Meme clicked');
            const text = memeInput.value || 'Your Meme Here';
            const template = memeTemplate.value;
            generateMemes(text, template);
        });

        downloadMeme.addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = memeCanvas.toDataURL('image/png');
            link.download = 'gamevibehub-meme.png';
            link.click();
        });

        drawFallbackMeme('Your Meme Here');

        // Poll Logic
        const pollButtons = document.querySelectorAll('.poll-btn');
        const pollResults = document.getElementById('poll-results');
        pollButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const game = button.dataset.game;
                try {
                    const gameRef = ref(database, `polls/${game}`);
                    const snapshot = await get(gameRef);
                    const currentVotes = snapshot.exists() ? snapshot.val().votes : 0;
                    await set(gameRef, { votes: currentVotes + 1 });
                    updatePollResults();
                } catch (error) {
                    console.error('Poll error:', error);
                    pollResults.textContent = 'Error submitting vote. Try again.';
                }
            });
        });

        function updatePollResults() {
            onValue(ref(database, 'polls'), (snapshot) => {
                const data = snapshot.val() || {};
                const totalVotes = Object.values(data).reduce((sum, game) => sum + (game.votes || 0), 0);
                let results = 'Poll Results:<br>';
                for (const [game, info] of Object.entries(data)) {
                    const votes = info.votes || 0;
                    const percentage = totalVotes ? ((votes / totalVotes) * 100).toFixed(1) : 0;
                    results += `${game.charAt(0).toUpperCase() + game.slice(1)}: ${votes} votes (${percentage}%)<br>`;
                }
                pollResults.innerHTML = totalVotes ? results : 'No votes yet!';
            });
        }
        updatePollResults();

        // Leaderboard Logic
        const submitScore = document.getElementById('submit-score');
        const leaderboardList = document.getElementById('leaderboard-list');
        submitScore.addEventListener('click', async () => {
            const username = document.getElementById('username').value.trim();
            const score = parseInt(document.getElementById('score').value);
            if (username && score >= 0) {
                try {
                    await push(ref(database, 'leaderboard'), { username, score, timestamp: Date.now() });
                    document.getElementById('username').value = '';
                    document.getElementById('score').value = '';
                    updateLeaderboard();
                } catch (error) {
                    console.error('Leaderboard error:', error);
                    leaderboardList.textContent = 'Error submitting score. Try again.';
                }
            }
        });

        function updateLeaderboard() {
            onValue(ref(database, 'leaderboard'), (snapshot) => {
                const data = snapshot.val() || {};
                const scores = Object.entries(data)
                    .map(([id, { username, score }]) => ({ id, username, score }))
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);
                leaderboardList.innerHTML = scores.length
                    ? scores.map((entry, i) => `${i + 1}. ${entry.username}: ${entry.score}`).join('<br>')
                    : 'No scores yet!';
            });
        }
        updateLeaderboard();

        // Gallery Logic
        const submitImage = document.getElementById('submit-image');
        const galleryImages = document.getElementById('gallery-images');
        submitImage.addEventListener('click', async () => {
            const url = document.getElementById('image-url').value.trim();
            const caption = document.getElementById('caption').value.trim();
            if (url && caption) {
                try {
                    await push(ref(database, 'gallery'), { url, caption, timestamp: Date.now() });
                    document.getElementById('image-url').value = '';
                    document.getElementById('caption').value = '';
                    updateGallery();
                } catch (error) {
                    console.error('Gallery error:', error);
                    galleryImages.innerHTML = '<p>Error submitting image. Try again.</p>';
                }
            }
        });

        function updateGallery() {
            onValue(ref(database, 'gallery'), (snapshot) => {
                const data = snapshot.val() || {};
                const images = Object.values(data);
                galleryImages.innerHTML = images.length
                    ? images.map(img => `
                        <div class="bg-gray-800 p-2 rounded">
                            <img src="${img.url}" alt="${img.caption}" class="w-32 h-32 object-cover rounded">
                            <p class="text-gray-300 text-sm mt-2">${img.caption}</p>
                        </div>
                    `).join('')
                    : '<p>No images yet!</p>';
            });
        }
        updateGallery();

        // Quote Logic
        const quotes = [
            "In Hearthstone, even a Murloc can be a legend. Believe in your deck!",
            "Fortnite dubs are built on sweat and a sturdy build. Keep grinding!",
            "Minecraft: Where every block you place tells a story. Build epic!",
            "Gaming is life, and GameVibeHub is the vibe. Let's play!",
            "A true gamer never blames the lag—they adapt and conquer!"
        ];
        const dailyQuote = document.getElementById('daily-quote');
        const newQuote = document.getElementById('new-quote');
        function displayQuote() {
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            dailyQuote.textContent = `"${randomQuote}"`;
        }
        newQuote.addEventListener('click', displayQuote);
        displayQuote();

        // Countdown Logic
        const countdownElement = document.getElementById('stream-countdown');
        function updateCountdown() {
            const now = new Date();
            const nextStream = new Date();
            nextStream.setHours(20, 0, 0, 0);
            if (now.getHours() >= 20) {
                nextStream.setDate(now.getDate() + 1);
            }
            const timeLeft = nextStream - now;
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            countdownElement.textContent = `${hours}h ${minutes}m`;
        }
        setInterval(updateCountdown, 60000);
        updateCountdown();
    </script>
</body>
</html>
